<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Farmer\Models\Upload;
use App\Jobs\ProcessFailedUpload;
use Illuminate\Support\Facades\Queue;
use App\Farmer\Models\Protocol\Device;
use App\Farmer\Models\Protocol\Sample;
use Illuminate\Foundation\Testing\RefreshDatabase;

class ProcessFailedUploadTest extends TestCase
{
    use RefreshDatabase;

    protected $rawJson;

    public function setUp()
    {
        parent::setUp();
        $this->rawJson = "{\"uuId\":\"29d4f855-9190-490c-a4ad-7975104205c2\",\"timestamp\":1507566710085,\"version\":11,\"database\":3,\"batteryState\":\"Charging\",\"batteryLevel\":0.46,\"memoryWired\":0,\"memoryActive\":554320,\"memoryInactive\":598428,\"memoryFree\":1911388,\"memoryUser\":69512,\"triggeredBy\":\"android.intent.action.BATTERY_CHANGED\",\"networkStatus\":\"lte\",\"distanceTraveled\":0,\"screenBrightness\":-1,\"networkDetails\":{\"networkType\":\"MOBILE\",\"mobileNetworkType\":\"lte\",\"mobileDataStatus\":\"connected\",\"mobileDataActivity\":\"none\",\"roamingEnabled\":0,\"wifiStatus\":\"enabled\",\"wifiSignalStrength\":-127,\"wifiLinkSpeed\":-1,\"wifiApStatus\":\"disabled\",\"networkOperator\":\"NOS\",\"simOperator\":\"NOS\",\"mcc\":\"268\",\"mnc\":\"03\"},\"batteryDetails\":{\"charger\":\"ac\",\"health\":\"Good\",\"voltage\":3.9990000724792,\"temperature\":31.700000762939,\"technology\":\"Li-ion\",\"capacity\":0,\"chargeCounter\":1600780,\"currentAverage\":0,\"currentNow\":843,\"energyCounter\":-1},\"cpuStatus\":{\"cpuUsage\":0.31410256410256,\"upTime\":98692,\"sleepTime\":42912},\"screenOn\":1,\"timeZone\":\"Atlantic\/Madeira\",\"settings\":{\"bluetoothEnabled\":true,\"locationEnabled\":true,\"powersaverEnabled\":false,\"flashlightEnabled\":false,\"nfcEnabled\":false,\"unknownSources\":1,\"developerMode\":0},\"storageDetails\":{\"free\":2910,\"total\":11083,\"freeExternal\":2910,\"totalExternal\":11083,\"freeSystem\":617,\"totalSystem\":2440,\"freeSecondary\":0,\"totalSecondary\":0},\"countryCode\":\"pt\",\"locationProviders\":[{\"provider\":\"passive\"},{\"provider\":\"gps\"},{\"provider\":\"network\"}],\"features\":[{\"key\":\"vm\",\"value\":\"2.1.0\"}],\"processInfos\":[{\"processId\":8655,\"name\":\"com.hmatalonga.greenhub\",\"applicationLabel\":\"BatteryHub\",\"isSystemApp\":false,\"importance\":\"Foreground app\",\"versionName\":\"v1.0.0\",\"versionCode\":11,\"installationPkg\":\"com.android.vending\"},{\"processId\":24457,\"name\":\"com.android.bluetooth\",\"applicationLabel\":\"Bluetooth Share\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.0\",\"versionCode\":24,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"android.permission.ACCESS_BLUETOOTH_SHARE\"},{\"permission\":\"com.android.permission.WHITELIST_BLUETOOTH_DEVICE\"}]},{\"processId\":11354,\"name\":\"com.google.android.apps.messaging:rcs\",\"applicationLabel\":null,\"isSystemApp\":false,\"importance\":\"Service\",\"versionName\":null,\"versionCode\":0,\"installationPkg\":\"null\"},{\"processId\":12541,\"name\":\"com.qualcomm.telephony\",\"applicationLabel\":\"com.qualcomm.atfwd\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.0\",\"versionCode\":24,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.qualcomm.permission.ATCMD\"}]},{\"processId\":7244,\"name\":\"com.motorola.ccc\",\"applicationLabel\":\"Notifica\u00e7\u00f5es Motorola\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.4.011\",\"versionCode\":74011,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.motorola.ccc.notification.READ_NOTIFICATIONS\"},{\"permission\":\"com.motorola.ccc.notification.WRITE_NOTIFICATIONS\"},{\"permission\":\"com.motorola.ccc.notification.permission.C2D_MESSAGE\"}]},{\"processId\":0,\"name\":\"com.google.android.music:main\",\"applicationLabel\":\"Google Play M\u00fasica\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.12.5218-1.V.4310085\",\"versionCode\":52181,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.google.android.music.permission.C2D_MESSAGE\"}]},{\"processId\":4550,\"name\":\"com.android.phone\",\"applicationLabel\":\"Servi\u00e7os de telem\u00f3vel\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.0\",\"versionCode\":24,\"installationPkg\":\"null\"},{\"processId\":1504,\"name\":\"system\",\"applicationLabel\":\"Localiza\u00e7\u00e3o Fundida\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.0\",\"versionCode\":24,\"installationPkg\":\"null\"},{\"processId\":5283,\"name\":\"com.motorola.actions\",\"applicationLabel\":\"Moto A\u00e7\u00f5es\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"03.006.0.1-N\",\"versionCode\":240030061,\"installationPkg\":\"com.android.vending\",\"appPermissions\":[{\"permission\":\"com.motorola.actions.provider.permission.READ_MODES\"},{\"permission\":\"com.motorola.actions.provider.permission.WRITE_MODES\"},{\"permission\":\"com.motorola.permission.START_MICROSCREEN\"},{\"permission\":\"com.motorola.permission.MICROSCREEN_RECEIVER\"},{\"permission\":\"com.motorola.attentivedisplay.permission.READ_CAMERA_STATE\"}]},{\"processId\":24549,\"name\":\"com.google.android.gms.persistent\",\"applicationLabel\":\"Google Backup Transport\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.0-3037786\",\"versionCode\":24,\"installationPkg\":\"null\"},{\"processId\":5268,\"name\":\"com.motorola.process.slpc\",\"applicationLabel\":\"Motorola Slpc System\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"1.00.01\",\"versionCode\":10001,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.motorola.slpc_sys.permission.START_SERVICE\"}]},{\"processId\":4327,\"name\":\"com.android.systemui\",\"applicationLabel\":\"IU do sist.\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.0\",\"versionCode\":24,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.motorola.permission.DOZE_HOST_SERVICE\"},{\"permission\":\"com.android.systemui.permission.SELF\"},{\"permission\":\"com.motorola.permission.CB_ENABLE\"}]},{\"processId\":24563,\"name\":\"com.google.android.gms\",\"applicationLabel\":\"Servi\u00e7os do Google Play\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"11.5.18 (438-170253583)\",\"versionCode\":11518438,\"installationPkg\":\"com.android.vending\",\"appPermissions\":[{\"permission\":\"com.google.android.gms.permission.INTERNAL_BROADCAST\"},{\"permission\":\"com.google.android.gms.common.internal.SHARED_PREFERENCES_PERMISSION\"},{\"permission\":\"com.google.android.gms.permission.CHECKIN_NOW\"},{\"permission\":\"com.google.android.gms.auth.permission.GOOGLE_ACCOUNT_CHANGE\"},{\"permission\":\"com.google.android.gms.auth.permission.POST_SIGN_IN_ACCOUNT\"},{\"permission\":\"com.google.android.gms.auth.permission.FACE_UNLOCK\"},{\"permission\":\"com.google.android.gms.permission.GRANT_WALLPAPER_PERMISSIONS\"},{\"permission\":\"com.google.android.gms.trustagent.permission.TRUSTAGENT_STATE\"},{\"permission\":\"com.google.android.gms.chromesync.permission.CONTENT_PROVIDER_ACCESS\"},{\"permission\":\"com.google.android.gms.chromesync.permission.METADATA_UPDATED\"},{\"permission\":\"com.google.android.gms.trustagent.framework.model.DATA_ACCESS\"},{\"permission\":\"com.google.android.gms.trustagent.framework.model.DATA_CHANGE_NOTIFICATION\"},{\"permission\":\"com.google.android.gms.permission.APPINDEXING\"},{\"permission\":\"com.google.android.gms.auth.cryptauth.permission.KEY_CHANGE\"},{\"permission\":\"com.google.android.gms.magictether.permission.CLIENT_TETHERING_PREFERENCE_CHANGED\"},{\"permission\":\"com.google.android.gms.magictether.permission.CONNECTED_HOST_CHANGED\"},{\"permission\":\"com.google.android.gms.magictether.permission.DISABLE_SOFT_AP\"},{\"permission\":\"com.google.android.gms.magictether.permission.SCANNED_DEVICE\"},{\"permission\":\"com.google.android.gms.permission.SAFETY_NET\"},{\"permission\":\"com.google.android.gms.googlehelp.LAUNCH_SUPPORT_SCREENSHARE\"},{\"permission\":\"com.google.android.gms.cloudsave.BIND_EVENT_BROADCAST\"},{\"permission\":\"com.google.android.gms.chimera.permission.QUERY_MODULES\"},{\"permission\":\"com.google.android.gms.permission.PHENOTYPE_UPDATE_BROADCAST\"},{\"permission\":\"com.google.android.gms.permission.AD_ID_NOTIFICATION\"},{\"permission\":\"com.google.android.gms.auth.authzen.permission.DEVICE_SYNC_FINISHED\"},{\"permission\":\"com.google.android.gms.auth.authzen.permission.GCM_DEVICE_PROXIMITY\"},{\"permission\":\"com.google.android.gms.auth.authzen.permission.KEY_REGISTRATION_FINISHED\"},{\"permission\":\"com.google.android.gms.permission.CAR_FUEL\"},{\"permission\":\"com.google.android.gms.permission.CAR_MILEAGE\"},{\"permission\":\"com.google.android.gms.permission.CAR_SPEED\"},{\"permission\":\"com.google.android.gms.permission.CAR_VENDOR_EXTENSION\"},{\"permission\":\"com.google.android.gms.DRIVE\"},{\"permission\":\"com.google.android.gms.permission.GAMES_DEBUG_SETTINGS\"},{\"permission\":\"com.google.android.gms.permission.C2D_MESSAGE\"},{\"permission\":\"com.google.android.gms.permission.BIND_NETWORK_TASK_SERVICE\"},{\"permission\":\"com.google.android.gms.permission.BROADCAST_TO_GOOGLEHELP\"},{\"permission\":\"com.google.android.gms.permission.ACTIVITY_RECOGNITION\"},{\"permission\":\"com.google.android.gms.permission.CONTACTS_SYNC_DELEGATION\"},{\"permission\":\"com.google.android.gms.auth.api.signin.permission.REVOCATION_NOTIFICATION\"},{\"permission\":\"com.google.android.gms.WRITE_VERIFY_APPS_CONSENT\"},{\"permission\":\"com.google.android.gms.permission.SEND_ANDROID_PAY_DATA\"},{\"permission\":\"com.google.android.gms.permission.SHOW_TRANSACTION_RECEIPT\"},{\"permission\":\"com.google.android.gms.permission.REPORT_TAP\"},{\"permission\":\"com.google.android.gms.permission.SHOW_PAYMENT_CARD_DETAILS\"},{\"permission\":\"com.google.android.gms.permission.READ_VALUABLES_IMAGES\"},{\"permission\":\"com.google.android.gms.permission.SHOW_WARM_WELCOME_TAPANDPAY_APP\"},{\"permission\":\"com.google.android.gms.chimera.permission.CONFIG_CHANGE\"},{\"permission\":\"com.google.android.gms.permission.CAR\"}]},{\"processId\":24712,\"name\":\"com.android.vending\",\"applicationLabel\":\"Google Play Store\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"8.2.56.T-all [0] [FP] 170066809\",\"versionCode\":80825600,\"installationPkg\":\"com.android.vending\",\"appPermissions\":[{\"permission\":\"com.android.vending.appdiscoveryservice.permission.ACCESS_APP_DISCOVERY_SERVICE\"},{\"permission\":\"com.android.vending.CHECK_LICENSE\"},{\"permission\":\"com.android.vending.BILLING\"},{\"permission\":\"com.android.vending.permission.C2D_MESSAGE\"},{\"permission\":\"com.android.vending.billing.IN_APP_NOTIFY.permission.C2D_MESSAGE\"},{\"permission\":\"com.android.vending.billing.BILLING_ACCOUNT_SERVICE\"},{\"permission\":\"com.android.vending.billing.ADD_CREDIT_CARD\"},{\"permission\":\"com.android.vending.TOS_ACKED\"},{\"permission\":\"com.android.vending.setup.PLAY_SETUP_SERVICE\"},{\"permission\":\"com.google.android.finsky.permission.GEARHEAD_SERVICE\"},{\"permission\":\"com.google.android.vending.verifier.ACCESS_VERIFIER\"},{\"permission\":\"com.google.android.finsky.permission.INSTANT_APP_STATE\"}]},{\"processId\":5230,\"name\":\".dataservices\",\"applicationLabel\":\"com.qualcomm.qti.tetherservice\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"1.0\",\"versionCode\":1,\"installationPkg\":\"null\"},{\"processId\":5296,\"name\":\"com.motorola.modemservice\",\"applicationLabel\":\"Motorola Modem Service\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"1.0\",\"versionCode\":1,\"installationPkg\":\"null\"},{\"processId\":11373,\"name\":\"com.google.android.ims\",\"applicationLabel\":\"Carrier Services\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"5.0.170203160\",\"versionCode\":30006529,\"installationPkg\":\"com.android.vending\",\"appPermissions\":[{\"permission\":\"com.google.android.ims.providers.ACCESS_DATA\"}]},{\"processId\":4527,\"name\":\"com.motorola.process.system\",\"applicationLabel\":\"MotoCareInt\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"1.0\",\"versionCode\":1,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.motorola.motocare.internal.INTERNAL_API\"}]},{\"processId\":4991,\"name\":\"com.google.android.ext.services\",\"applicationLabel\":\"Android Services Library\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"1\",\"versionCode\":1,\"installationPkg\":\"null\"},{\"processId\":7186,\"name\":\"com.motorola.slpc\",\"applicationLabel\":\"Motorola Modality Services\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"23.002.001\",\"versionCode\":23002001,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.motorola.slpc.permission.SENSORHUB\"},{\"permission\":\"com.motorola.slpc.permission.BIND_SERVICE\"},{\"permission\":\"com.motorola.slpc.permission.RECEIVER\"}]},{\"processId\":4737,\"name\":\"com.qualcomm.qcrilmsgtunnel\",\"applicationLabel\":\"com.qualcomm.qcrilmsgtunnel\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"7.0\",\"versionCode\":24,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.qualcomm.permission.USE_QCRIL_MSG_TUNNEL\"}]},{\"processId\":12827,\"name\":\"uk.amazon.mShop.android\",\"applicationLabel\":\"Amazon\",\"isSystemApp\":false,\"importance\":\"Service\",\"versionName\":\"12.8.0.200\",\"versionCode\":1241080010,\"installationPkg\":\"uk.amazon.mShop.android\",\"appPermissions\":[{\"permission\":\"uk.amazon.mShop.android.permission.C2D_MESSAGE\"},{\"permission\":\"com.amazon.CONTENT_PROVIDER_ACCESS\"},{\"permission\":\"com.amazon.identity.permission.CAN_CALL_MAP_INFORMATION_PROVIDER\"},{\"permission\":\"com.amazon.identity.auth.device.perm.AUTH_SDK\"},{\"permission\":\"com.amazon.dcp.sso.permission.account.changed\"},{\"permission\":\"com.amazon.dcp.sso.permission.AmazonAccountPropertyService.property.changed\"},{\"permission\":\"com.amazon.identity.permission.CALL_AMAZON_DEVICE_INFORMATION_PROVIDER\"},{\"permission\":\"com.amazon.appmanager.preload.permission.READ_PRELOAD_DEVICE_INFO_PROVIDER\"},{\"permission\":\"com.amazon.mas.client.settings.provider.CONTENT_PROVIDER_ACCESS\"},{\"permission\":\"com.amazon.dcp.sso.permission.MANAGE_COR_PFM\"},{\"permission\":\"com.amazon.mas.client.GLOBAL_BROADCAST_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.settings.SETTING_CHANGE_BROADCAST_PERMISSION\"},{\"permission\":\"com.amazon.dcp.settings.permission.READ_SETTINGS\"},{\"permission\":\"com.amazon.mas.client.download.CONTENT_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.install.INSTALL_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.install.CONTENT_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.venezia.command.shared.AUTH_TOKEN_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.install.KICKOFF_INSTALL_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.install.RECEIVE_INSTALL_STATE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.CONTENT_PROVIDER_READ_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.authentication.permission.DEREGISTRATION_BROADCAST_PERMISSION_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.malware.blockedapp.BLOCKED_APP_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.inapp.purchasing.Permission.NOTIFY\"},{\"permission\":\"com.amazon.mas.client.framework.SAFEMODE_ACCESS\"},{\"permission\":\"com.amazon.mas.client.locker.LOCKER_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.licensing.LICENSING_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.venezia.command.shared.ACCOUNT_INFO_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.mas.client.pdiservice.db.provider.CONTENT_PROVIDER_WRITE_uk.amazon.mShop.android\"},{\"permission\":\"com.amazon.apps_unlocked.READ_STATUS\"},{\"permission\":\"com.amazon.avod.SDK_ACCESS\"},{\"permission\":\"com.amazon.client.metrics.nexus.permission.TRIGGER_UPLOAD\"}]},{\"processId\":7523,\"name\":\"sayantanrc.motodisplayhandwave\",\"applicationLabel\":\"MotoDisplay Handwave\",\"isSystemApp\":false,\"importance\":\"Service\",\"versionName\":\"3.1.1\",\"versionCode\":7,\"installationPkg\":\"com.android.vending\",\"appPermissions\":[{\"permission\":\"android.permission.MEDIA_CONTENT_CONTROL\"}]},{\"processId\":4296,\"name\":\"com.google.android.inputmethod.latin\",\"applicationLabel\":\"Gboard\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"6.6.15.171045231-release-armeabi-v7a\",\"versionCode\":26661509,\"installationPkg\":\"com.android.vending\",\"appPermissions\":[{\"permission\":\"com.google.android.apps.inputmethod.latin.permission.UPDATE_STICKER_INDEX\"}]},{\"processId\":7441,\"name\":\"com.motorola.motocare\",\"applicationLabel\":\"MotoCare\",\"isSystemApp\":true,\"importance\":\"Service\",\"versionName\":\"1.1\",\"versionCode\":2,\"installationPkg\":\"null\",\"appPermissions\":[{\"permission\":\"com.motorola.motocare.INTERNAL_ACTION\"}]},{\"processId\":5210,\"name\":\"com.google.android.googlequicksearchbox:interactor\",\"applicationLabel\":null,\"isSystemApp\":false,\"importance\":\"Service\",\"versionName\":null,\"versionCode\":0,\"installationPkg\":\"null\"},{\"processId\":5387,\"name\":\"net.megawave.flashalerts\",\"applicationLabel\":\"Flash Alerts 2\",\"isSystemApp\":false,\"importance\":\"Service\",\"versionName\":\"2.2.4\",\"versionCode\":23,\"installationPkg\":\"com.android.vending\"}]}";
    }

    /** @test */
    public function it_dispatches_a_process_failed_upload_job()
    {
        $device = $this->createDevice();
        $upload = Upload::create(['data' => $this->rawJson]);

        Queue::fake();
        Queue::assertNothingPushed();

        dispatch(new ProcessFailedUpload($device, $upload));

        Queue::assertPushed(ProcessFailedUpload::class, function ($job) use ($device) {
            return $job->device->id === $device->id;
        });
    }

    /** @test */
    public function it_handles_a_process_failed_upload_job()
    {
        $device = $this->createDevice();

        $upload = Upload::create(['data' => $this->rawJson]);

        $this->assertEquals(1, Upload::count());

        $job = new ProcessFailedUpload($device, $upload);

        $job->handle();

        $this->assertEquals(0, Upload::count());
        $this->assertEquals(1, Sample::count());
    }

    private function createDevice()
    {
        return Device::create([
            'uuid' => '29d4f855-9190-490c-a4ad-7975104205c2',
            'model' => 'nexus',
            'manufacturer' => 'google',
            'brand' => 'google',
            'product' => 'LG',
            'os_version' => '8.0.0',
            'kernel_version' => '4.0.0',
            'is_root' => false,
        ]);
    }
}
